name: E2E Tests

on:
    pull_request:
        branches: [main]
    push:
        branches: [main]
    workflow_dispatch:

env:
    GO_VERSION: "1.24"
    KIND_VERSION: "v0.25.0"
    KUBECTL_VERSION: "v1.31.0"
    HELM_VERSION: "v3.16.3"
    GATEWAY_API_VERSION: "v1.4.0"

jobs:
    build-image:
        name: Build Controller Image
        uses: ./.github/workflows/build-image.yaml
        permissions:
            contents: read
            packages: write
        with:
            push: true
            platforms: linux/amd64
            tags: |
                type=ref,event=pr
                type=ref,event=branch
                type=sha

    e2e-test:
        name: End-to-End Tests
        runs-on: ubuntu-latest
        needs: build-image

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Get Secrets
              uses: bitwarden/sm-action@v2
              with:
                  cloud_region: eu
                  access_token: ${{ secrets.BW_ACCESS_TOKEN }}
                  secrets: |
                      0bf9c2bd-f0d6-43f0-be07-b39400060b83 > CLOUDFLARE_ACCOUNT_ID
                      8305fd5c-2b7f-482d-8174-b393010e3a32 > CLOUDFLARE_API_TOKEN

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: ${{ env.GO_VERSION }}
                  cache: true

            - name: Install kubectl
              run: |
                  curl -LO "https://dl.k8s.io/release/${{ env.KUBECTL_VERSION }}/bin/linux/amd64/kubectl"
                  chmod +x kubectl
                  sudo mv kubectl /usr/local/bin/
                  kubectl version --client

            - name: Install kind
              run: |
                  curl -Lo ./kind "https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64"
                  chmod +x ./kind
                  sudo mv ./kind /usr/local/bin/kind
                  kind version

            - name: Install Helm
              uses: azure/setup-helm@v4.3.0
              id: install

            - name: Log in to Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Create kind cluster
              run: |
                  cat <<EOF | kind create cluster --config=-
                  kind: Cluster
                  apiVersion: kind.x-k8s.io/v1alpha4
                  name: cloudflare-gateway-e2e
                  nodes:
                  - role: control-plane
                    image: kindest/node:v1.31.0
                  - role: worker
                    image: kindest/node:v1.31.0
                  EOF

                  kubectl cluster-info
                  kubectl get nodes

            - name: Install Gateway API CRDs
              run: |
                  kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/${{ env.GATEWAY_API_VERSION }}/standard-install.yaml
                  kubectl wait --for condition=established --timeout=60s crd/gatewayclasses.gateway.networking.k8s.io
                  kubectl wait --for condition=established --timeout=60s crd/gateways.gateway.networking.k8s.io
                  kubectl wait --for condition=established --timeout=60s crd/httproutes.gateway.networking.k8s.io

            - name: Pull and load Docker image into kind
              run: |
                  IMAGE_TAG="${{ needs.build-image.outputs.image-tag }}"
                  echo "Using image: ghcr.io/${{ github.repository }}:${IMAGE_TAG}"

                  docker pull "ghcr.io/${{ github.repository }}:${IMAGE_TAG}"
                  kind load docker-image "ghcr.io/${{ github.repository }}:${IMAGE_TAG}" --name cloudflare-gateway-e2e

            - name: Add Helm repository and install controller
              run: |
                  IMAGE_TAG="${{ needs.build-image.outputs.image-tag }}"

                  helm repo add cloudflare-gateway-controller https://georgepstaylor.github.io/cloudflare-gateway-controller-helm-charts
                  helm repo update

                  helm install cloudflare-gateway-controller \
                    cloudflare-gateway-controller/cloudflare-gateway-controller \
                    --namespace cloudflare-gateway-system \
                    --create-namespace \
                    --set image.repository=ghcr.io/${{ github.repository }} \
                    --set image.tag="${IMAGE_TAG}" \
                    --set image.pullPolicy=IfNotPresent \
                    --set cloudflare.apiToken=${{ env.CLOUDFLARE_API_TOKEN }} \
                    --set cloudflare.accountId=${{ env.CLOUDFLARE_ACCOUNT_ID }} \
                    --wait --timeout=2m

            - name: Verify controller is running
              run: |
                  kubectl get pods -n cloudflare-gateway-system
                  kubectl logs -n cloudflare-gateway-system -l app.kubernetes.io/name=cloudflare-gateway-controller --tail=50

            - name: Create test namespace
              run: |
                  kubectl create namespace hello-world

            - name: Create GatewayClass
              run: |
                  cat <<EOF | kubectl apply -f -
                  apiVersion: gateway.networking.k8s.io/v1
                  kind: GatewayClass
                  metadata:
                    name: cloudflare
                  spec:
                    controllerName: george.dev/cloudflare-gateway-controller
                    parametersRef:
                      group: ""
                      kind: Secret
                      name: cloudflare-credentials
                      namespace: cloudflare-gateway-system
                  EOF

            - name: Wait for GatewayClass to be accepted
              run: |
                  timeout 60s bash -c 'until kubectl get gatewayclass cloudflare -o jsonpath="{.status.conditions[?(@.type==\"Accepted\")].status}" | grep -q "True"; do sleep 2; done' || true
                  kubectl get gatewayclass cloudflare -o yaml

            - name: Create Gateway
              run: |
                  cat <<EOF | kubectl apply -f -
                  apiVersion: gateway.networking.k8s.io/v1
                  kind: Gateway
                  metadata:
                    name: hello-world-gateway
                    namespace: hello-world
                  spec:
                    gatewayClassName: cloudflare
                    listeners:
                      - name: http
                        protocol: HTTP
                        port: 80
                  EOF

            - name: Wait for Gateway to be programmed
              run: |
                  timeout 60s bash -c 'until kubectl get gateway hello-world-gateway -n hello-world -o jsonpath="{.status.conditions[?(@.type==\"Programmed\")].status}" | grep -q "True"; do sleep 2; done' || true
                  kubectl get gateway hello-world-gateway -n hello-world -o yaml

            - name: Deploy test application
              run: |
                  kubectl apply -f - <<EOF
                  apiVersion: apps/v1
                  kind: Deployment
                  metadata:
                    name: hello-world
                    namespace: hello-world
                  spec:
                    replicas: 1
                    selector:
                      matchLabels:
                        app: hello-world
                    template:
                      metadata:
                        labels:
                          app: hello-world
                      spec:
                        containers:
                        - name: echo-server
                          image: ealen/echo-server:latest
                          ports:
                          - containerPort: 80
                          env:
                          - name: PORT
                            value: "80"
                  ---
                  apiVersion: v1
                  kind: Service
                  metadata:
                    name: hello-world
                    namespace: hello-world
                  spec:
                    selector:
                      app: hello-world
                    ports:
                    - protocol: TCP
                      port: 8080
                      targetPort: 80
                  EOF

            - name: Wait for application to be ready
              run: |
                  kubectl wait --for=condition=available --timeout=120s \
                    deployment/hello-world -n hello-world
                  kubectl get pods -n hello-world

            - name: Create HTTPRoute
              run: |
                  cat <<EOF | kubectl apply -f -
                  apiVersion: gateway.networking.k8s.io/v1
                  kind: HTTPRoute
                  metadata:
                    name: hello-world
                    namespace: hello-world
                  spec:
                    parentRefs:
                      - name: hello-world-gateway
                        namespace: hello-world
                    hostnames:
                      - "cfgc.george.dev"
                    rules:
                      - matches:
                          - path:
                              type: PathPrefix
                              value: /
                        backendRefs:
                          - name: hello-world
                            port: 8080
                  EOF

            - name: Wait for HTTPRoute to be accepted
              run: |
                  timeout 60s bash -c 'until kubectl get httproute hello-world -n hello-world -o jsonpath="{.status.parents[0].conditions[?(@.type==\"Accepted\")].status}" | grep -q "True"; do sleep 2; done' || true
                  kubectl get httproute hello-world -n hello-world -o yaml

            - name: Verify resources are created
              run: |
                  echo "=== GatewayClass ==="
                  kubectl get gatewayclass cloudflare -o yaml

                  echo -e "\n=== Gateway ==="
                  kubectl get gateway hello-world-gateway -n hello-world -o yaml

                  echo -e "\n=== HTTPRoute ==="
                  kubectl get httproute hello-world -n hello-world -o yaml

                  echo -e "\n=== Controller Logs ==="
                  kubectl logs -n cloudflare-gateway-system -l app.kubernetes.io/name=cloudflare-gateway-controller --tail=100

            - name: Check controller health
              run: |
                  kubectl get pods -n cloudflare-gateway-system -o wide
                  helm list -n cloudflare-gateway-system
                  kubectl describe deployment -n cloudflare-gateway-system -l app.kubernetes.io/name=cloudflare-gateway-controller

            - name: Test public access to application
              run: |
                  curl -L https://cfgc.george.dev -H "Host: cfgc.george.dev" --max-time 10

            - name: Export logs on failure
              if: failure()
              run: |
                  echo "=== All pods ==="
                  kubectl get pods --all-namespaces

                  echo -e "\n=== Helm releases ==="
                  helm list -A || true

                  echo -e "\n=== Controller logs ==="
                  kubectl logs -n cloudflare-gateway-system -l app.kubernetes.io/name=cloudflare-gateway-controller --tail=200 || true

                  echo -e "\n=== Gateway resources ==="
                  kubectl get gatewayclasses,gateways,httproutes --all-namespaces -o yaml || true

                  echo -e "\n=== Events ==="
                  kubectl get events --all-namespaces --sort-by='.lastTimestamp' || true

            - name: Cleanup
              if: always()
              run: |
                  kind delete cluster --name cloudflare-gateway-e2e || true
